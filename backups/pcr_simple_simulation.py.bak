#!/usr/bin/env python3
"""
PCR Simple Simulation - Versi贸n simplificada sin MediaPipe
Simulaci贸n del proceso de PCR usando c茅lulas term贸filas (compatible con Python 3.13)
"""

import pygame
import numpy as np
import sys
import os
import math
import random
from typing import List, Tuple, Optional
from OpenGL.GL import *
from OpenGL.GLU import *

class PCRStage:
    """Estados del proceso de PCR"""
    DENATURATION = "denaturation"  # 94掳C - Separaci贸n de cadenas
    ANNEALING = "annealing"        # 50-65掳C - Uni贸n de primers
    EXTENSION = "extension"        # 72掳C - S铆ntesis de nueva cadena
    COOLING = "cooling"           # Enfriamiento

class SimpleThermophilicCell:
    """Representaci贸n simplificada de una c茅lula term贸fila"""
    
    def __init__(self, x: float, y: float, z: float):
        self.x = x
        self.y = y
        self.z = z
        self.original_x = x
        self.original_y = y
        self.original_z = z
        self.temperature = 25.0
        self.target_temp = 25.0
        self.energy = 100.0
        self.active = True
        self.color = (0.2, 0.8, 0.2)
        self.size = random.uniform(0.5, 1.5)
        self.animation_phase = random.uniform(0, 2 * math.pi)
        
    def update(self, dt: float, pcr_stage: str, mouse_pos: Optional[Tuple[float, float, float]] = None):
        """Actualiza el estado de la c茅lula"""
        
        # Cambio de temperatura seg煤n la etapa
        if pcr_stage == PCRStage.DENATURATION:
            self.target_temp = 94.0
        elif pcr_stage == PCRStage.ANNEALING:
            self.target_temp = 55.0
        elif pcr_stage == PCRStage.EXTENSION:
            self.target_temp = 72.0
        else:  # COOLING
            self.target_temp = 25.0
            
        # Interacci贸n con el mouse (simula interacci贸n de manos)
        if mouse_pos:
            mouse_x, mouse_y, mouse_z = mouse_pos
            distance = math.sqrt((self.x - mouse_x)**2 + (self.y - mouse_y)**2 + (self.z - mouse_z)**2)
            
            if distance < 3.0:  # Radio de influencia
                # El mouse puede "tocar" las c茅lulas para activarlas
                self.energy = min(100.0, self.energy + 10.0 * dt)
                self.active = True
                
                # Efecto de movimiento hacia el mouse
                influence = max(0, 1.0 - distance / 3.0)
                self.x += (mouse_x - self.x) * influence * dt * 0.5
                self.y += (mouse_y - self.y) * influence * dt * 0.5
                self.z += (mouse_z - self.z) * influence * dt * 0.5
        
        # Transici贸n suave de temperatura
        temp_diff = self.target_temp - self.temperature
        self.temperature += temp_diff * dt * 2.0
        
        # Efectos visuales basados en temperatura
        if self.temperature > 80:
            self.color = (0.8, 0.2, 0.2)  # Rojo para altas temperaturas
        elif self.temperature > 60:
            self.color = (0.8, 0.6, 0.2)  # Naranja
        elif self.temperature > 40:
            self.color = (0.8, 0.8, 0.2)  # Amarillo
        else:
            self.color = (0.2, 0.8, 0.2)  # Verde
            
        # Consumo de energ铆a
        if self.active:
            self.energy -= dt * 5.0
            if self.energy <= 0:
                self.active = False
                self.color = (0.5, 0.5, 0.5)  # Gris para c茅lulas inactivas
        
        # Animaci贸n de flotaci贸n
        self.animation_phase += dt * 2.0
        self.y += math.sin(self.animation_phase) * dt * 0.1

class SimplePCRSimulation:
    """Simulaci贸n simplificada del proceso de PCR"""
    
    def __init__(self, width: int = 1280, height: int = 720):
        pygame.init()
        self.width = width
        self.height = height
        self.screen = pygame.display.set_mode((width, height), pygame.OPENGL | pygame.DOUBLEBUF)
        pygame.display.set_caption("PCR Simple - Termophilic Cells")
        
        # Configuraci贸n de OpenGL
        glEnable(GL_DEPTH_TEST)
        glEnable(GL_BLEND)
        glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA)
        glClearColor(0.0, 0.0, 0.1, 1.0)
        
        # C谩mara
        self.camera_distance = 10.0
        self.camera_rotation_x = 0.0
        self.camera_rotation_y = 0.0
        
        # PCR
        self.current_stage = PCRStage.COOLING
        self.stage_timer = 0.0
        self.cycle_count = 0
        self.max_cycles = 30
        
        # C茅lulas term贸filas
        self.cells: List[SimpleThermophilicCell] = []
        self.generate_cells(50)
        
        # Mouse tracking
        self.mouse_pos = None
        self.mouse_pressed = False
        
        # Controles
        self.paused = False
        
    def generate_cells(self, count: int):
        """Genera c茅lulas term贸filas aleatorias"""
        for _ in range(count):
            x = random.uniform(-8, 8)
            y = random.uniform(-4, 4)
            z = random.uniform(-5, 5)
            self.cells.append(SimpleThermophilicCell(x, y, z))
    
    def handle_events(self):
        """Maneja eventos de pygame"""
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                return False
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_ESCAPE:
                    return False
                elif event.key == pygame.K_SPACE:
                    self.next_pcr_stage()
                elif event.key == pygame.K_p:
                    self.paused = not self.paused
                elif event.key == pygame.K_r:
                    self.reset_simulation()
            elif event.type == pygame.MOUSEMOTION:
                if event.buttons[0]:  # Bot贸n izquierdo
                    self.camera_rotation_y += event.rel[0] * 0.01
                    self.camera_rotation_x += event.rel[1] * 0.01
                    
                    # Convertir posici贸n del mouse a coordenadas 3D
                    mouse_x, mouse_y = event.pos
                    normalized_x = (mouse_x / self.width - 0.5) * 16
                    normalized_y = (0.5 - mouse_y / self.height) * 8
                    self.mouse_pos = (normalized_x, normalized_y, 0)
                else:
                    self.mouse_pos = None
            elif event.type == pygame.MOUSEBUTTONDOWN:
                if event.button == 1:  # Bot贸n izquierdo
                    self.mouse_pressed = True
                elif event.button == 4:  # Scroll up
                    self.camera_distance = max(2.0, self.camera_distance - 0.5)
                elif event.button == 5:  # Scroll down
                    self.camera_distance = min(20.0, self.camera_distance + 0.5)
            elif event.type == pygame.MOUSEBUTTONUP:
                if event.button == 1:
                    self.mouse_pressed = False
                    self.mouse_pos = None
        
        return True
    
    def next_pcr_stage(self):
        """Avanza a la siguiente etapa del PCR"""
        if self.current_stage == PCRStage.COOLING:
            self.current_stage = PCRStage.DENATURATION
            self.stage_timer = 0.0
        elif self.current_stage == PCRStage.DENATURATION:
            self.current_stage = PCRStage.ANNEALING
            self.stage_timer = 0.0
        elif self.current_stage == PCRStage.ANNEALING:
            self.current_stage = PCRStage.EXTENSION
            self.stage_timer = 0.0
        elif self.current_stage == PCRStage.EXTENSION:
            self.current_stage = PCRStage.COOLING
            self.stage_timer = 0.0
            self.cycle_count += 1
    
    def reset_simulation(self):
        """Reinicia la simulaci贸n"""
        self.current_stage = PCRStage.COOLING
        self.stage_timer = 0.0
        self.cycle_count = 0
        for cell in self.cells:
            cell.temperature = 25.0
            cell.energy = 100.0
            cell.active = True
            cell.x = cell.original_x
            cell.y = cell.original_y
            cell.z = cell.original_z
    
    def update(self, dt: float):
        """Actualiza la simulaci贸n"""
        if self.paused:
            return
        
        # Actualizar timer de etapa
        self.stage_timer += dt
        
        # Auto-avanzar etapas despu茅s de cierto tiempo
        stage_duration = 3.0  # 3 segundos por etapa
        if self.stage_timer >= stage_duration:
            self.next_pcr_stage()
        
        # Actualizar c茅lulas
        for cell in self.cells:
            cell.update(dt, self.current_stage, self.mouse_pos)
    
    def render_cells(self):
        """Renderiza las c茅lulas term贸filas"""
        glEnable(GL_POINT_SMOOTH)
        glPointSize(8.0)
        
        glBegin(GL_POINTS)
        for cell in self.cells:
            if cell.active:
                glColor3f(*cell.color)
                glVertex3f(cell.x, cell.y, cell.z)
        glEnd()
        
        # Renderizar c茅lulas inactivas en gris
        glColor3f(0.5, 0.5, 0.5)
        glBegin(GL_POINTS)
        for cell in self.cells:
            if not cell.active:
                glVertex3f(cell.x, cell.y, cell.z)
        glEnd()
    
    def render_dna_visualization(self):
        """Renderiza visualizaci贸n simplificada del DNA"""
        glColor3f(0.8, 0.8, 1.0)  # Azul claro para DNA
        glLineWidth(2.0)
        
        # DNA en el centro
        glBegin(GL_LINES)
        for i in range(3):
            y_offset = i * 0.5 - 1.0
            if self.current_stage == PCRStage.DENATURATION:
                # DNA separ谩ndose
                separation = math.sin(pygame.time.get_ticks() * 0.001 + i) * 0.3
                glVertex3f(-2.0 + separation, y_offset, 0)
                glVertex3f(2.0 + separation, y_offset, 0)
                glVertex3f(-2.0 - separation, y_offset + 0.1, 0)
                glVertex3f(2.0 - separation, y_offset + 0.1, 0)
            else:
                # DNA normal
                glVertex3f(-2.0, y_offset, 0)
                glVertex3f(2.0, y_offset, 0)
        glEnd()
    
    def render_ui(self):
        """Renderiza la interfaz de usuario"""
        # Cambiar a modo 2D para UI
        glMatrixMode(GL_PROJECTION)
        glPushMatrix()
        glLoadIdentity()
        gluOrtho2D(0, self.width, 0, self.height)
        
        glMatrixMode(GL_MODELVIEW)
        glPushMatrix()
        glLoadIdentity()
        
        # Deshabilitar depth test para UI
        glDisable(GL_DEPTH_TEST)
        
        # Informaci贸n de PCR
        font = pygame.font.Font(None, 36)
        
        # Etapa actual
        stage_text = f"Etapa: {self.current_stage.upper()}"
        stage_surface = font.render(stage_text, True, (255, 255, 255))
        self.screen.blit(stage_surface, (10, self.height - 100))
        
        # Ciclo actual
        cycle_text = f"Ciclo: {self.cycle_count}/{self.max_cycles}"
        cycle_surface = font.render(cycle_text, True, (255, 255, 255))
        self.screen.blit(cycle_surface, (10, self.height - 70))
        
        # Temperatura promedio
        avg_temp = sum(cell.temperature for cell in self.cells) / len(self.cells)
        temp_text = f"Temperatura: {avg_temp:.1f}掳C"
        temp_surface = font.render(temp_text, True, (255, 255, 255))
        self.screen.blit(temp_surface, (10, self.height - 40))
        
        # Controles
        controls_font = pygame.font.Font(None, 24)
        controls = [
            "ESPACIO: Siguiente etapa",
            "R: Reiniciar",
            "P: Pausar/Reanudar",
            "Mouse: Rotar c谩mara e interactuar",
            "Scroll: Zoom"
        ]
        
        for i, control in enumerate(controls):
            control_surface = controls_font.render(control, True, (200, 200, 200))
            self.screen.blit(control_surface, (self.width - 300, 10 + i * 25))
        
        # Restaurar configuraci贸n 3D
        glEnable(GL_DEPTH_TEST)
        glMatrixMode(GL_PROJECTION)
        glPopMatrix()
        glMatrixMode(GL_MODELVIEW)
        glPopMatrix()
    
    def render(self):
        """Renderiza la escena completa"""
        glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT)
        
        # Configurar c谩mara
        glMatrixMode(GL_PROJECTION)
        glLoadIdentity()
        gluPerspective(45, self.width / self.height, 0.1, 100.0)
        
        glMatrixMode(GL_MODELVIEW)
        glLoadIdentity()
        glTranslatef(0.0, 0.0, -self.camera_distance)
        glRotatef(self.camera_rotation_x, 1.0, 0.0, 0.0)
        glRotatef(self.camera_rotation_y, 0.0, 1.0, 0.0)
        
        # Renderizar c茅lulas
        self.render_cells()
        
        # Renderizar DNA
        self.render_dna_visualization()
        
        # Renderizar UI
        self.render_ui()
        
        pygame.display.flip()
    
    def run(self):
        """Bucle principal de la aplicaci贸n"""
        clock = pygame.time.Clock()
        running = True
        
        print("К PCR Simple Simulation iniciado")
        print(" Controles:")
        print("   - ESPACIO: Siguiente etapa PCR")
        print("   - R: Reiniciar simulaci贸n")
        print("   - P: Pausar/Reanudar")
        print("   - Mouse: Rotar c谩mara e interactuar con c茅lulas")
        print("   - Scroll: Zoom")
        print("   - ESC: Salir")
        
        while running:
            dt = clock.tick(60) / 1000.0  # Delta time en segundos
            
            running = self.handle_events()
            self.update(dt)
            self.render()
        
        pygame.quit()
        sys.exit()

if __name__ == "__main__":
    simulation = SimplePCRSimulation()
    simulation.run() 