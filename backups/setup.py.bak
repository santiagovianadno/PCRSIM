#!/usr/bin/env python3
"""
Setup script para PCR Termophilic Cells Interactive Videomapping
Instala dependencias y configura el entorno
"""

import subprocess
import sys
import os
import platform

def check_python_version():
    """Verifica que la versi√≥n de Python sea compatible"""
    if sys.version_info < (3, 8):
        print("‚ùå Error: Se requiere Python 3.8 o superior")
        print(f"   Versi√≥n actual: {sys.version}")
        return False
    print(f"‚úÖ Python {sys.version.split()[0]} detectado")
    return True

def install_dependencies():
    """Instala las dependencias del proyecto"""
    print("\nüì¶ Instalando dependencias...")
    
    dependencies = [
        "opencv-python>=4.8.0",
        "mediapipe>=0.10.0",
        "pygame>=2.5.0",
        "numpy>=1.24.0",
        "pyopengl>=3.1.6",
        "plyfile>=0.7.4",
        "scipy>=1.10.0",
        "matplotlib>=3.7.0",
        "pillow>=9.5.0"
    ]
    
    for dep in dependencies:
        print(f"   Instalando {dep}...")
        try:
            subprocess.check_call([sys.executable, "-m", "pip", "install", dep])
            print(f"   ‚úÖ {dep} instalado correctamente")
        except subprocess.CalledProcessError:
            print(f"   ‚ùå Error instalando {dep}")
            return False
    
    return True

def check_camera():
    """Verifica que la c√°mara est√© disponible"""
    print("\nüì∑ Verificando c√°mara...")
    try:
        import cv2
        cap = cv2.VideoCapture(0)
        if cap.isOpened():
            ret, frame = cap.read()
            cap.release()
            if ret:
                print("‚úÖ C√°mara detectada y funcionando")
                return True
            else:
                print("‚ö†Ô∏è  C√°mara detectada pero no puede capturar im√°genes")
                return False
        else:
            print("‚ùå No se pudo acceder a la c√°mara")
            return False
    except Exception as e:
        print(f"‚ùå Error verificando c√°mara: {e}")
        return False

def check_opengl():
    """Verifica que OpenGL est√© disponible"""
    print("\nüéÆ Verificando OpenGL...")
    try:
        import pygame
        pygame.init()
        pygame.display.set_mode((100, 100), pygame.OPENGL)
        pygame.quit()
        print("‚úÖ OpenGL disponible")
        return True
    except Exception as e:
        print(f"‚ùå Error con OpenGL: {e}")
        return False

def create_directories():
    """Crea directorios necesarios"""
    print("\nüìÅ Creando directorios...")
    
    directories = ["models", "data", "logs"]
    for directory in directories:
        if not os.path.exists(directory):
            os.makedirs(directory)
            print(f"   ‚úÖ Creado directorio: {directory}")
        else:
            print(f"   üìÅ Directorio ya existe: {directory}")

def create_config_file():
    """Crea archivo de configuraci√≥n por defecto"""
    print("\n‚öôÔ∏è  Creando archivo de configuraci√≥n...")
    
    config_content = """# Configuraci√≥n para PCR Termophilic Cells Interactive
# Archivo de configuraci√≥n

[Display]
width = 1280
height = 720
fullscreen = false
vsync = true

[Camera]
device = 0
width = 640
height = 480
fps = 30

[PCR]
auto_advance = true
cycle_duration = 3.0
max_cycles = 30

[Cells]
initial_count = 50
max_divisions = 3
energy_consumption = 5.0

[Effects]
show_particles = true
show_dna = true
show_camera = true
particle_count = 100

[Controls]
mouse_sensitivity = 0.01
hand_influence_radius = 2.0
"""
    
    try:
        with open("config.ini", "w") as f:
            f.write(config_content)
        print("   ‚úÖ Archivo config.ini creado")
    except Exception as e:
        print(f"   ‚ùå Error creando config.ini: {e}")

def run_test():
    """Ejecuta una prueba b√°sica del sistema"""
    print("\nüß™ Ejecutando prueba del sistema...")
    
    try:
        # Importar m√≥dulos principales
        import pygame
        import cv2
        import mediapipe as mp
        import numpy as np
        from OpenGL.GL import glClear, GL_COLOR_BUFFER_BIT
        from plyfile import PlyData
        
        print("   ‚úÖ Todos los m√≥dulos importados correctamente")
        
        # Prueba b√°sica de pygame
        pygame.init()
        screen = pygame.display.set_mode((100, 100))
        pygame.quit()
        print("   ‚úÖ Pygame funcionando")
        
        # Prueba b√°sica de OpenCV
        cap = cv2.VideoCapture(0)
        if cap.isOpened():
            cap.release()
            print("   ‚úÖ OpenCV funcionando")
        
        print("‚úÖ Prueba del sistema completada exitosamente")
        return True
        
    except Exception as e:
        print(f"   ‚ùå Error en prueba del sistema: {e}")
        return False

def show_usage():
    """Muestra informaci√≥n de uso"""
    print("\n" + "="*60)
    print("üéâ ¬°Instalaci√≥n completada!")
    print("="*60)
    print("\nüìã Para ejecutar el proyecto:")
    print("   python pcr_thermophilic_simulation.py")
    print("   python pcr_advanced_simulation.py")
    print("\nüéÆ Controles principales:")
    print("   ESPACIO - Siguiente etapa PCR")
    print("   R - Reiniciar simulaci√≥n")
    print("   P - Pausar/Reanudar")
    print("   C - Mostrar/Ocultar c√°mara")
    print("   ESC - Salir")
    print("\nüìö Documentaci√≥n:")
    print("   README.md - Gu√≠a completa del proyecto")
    print("\nüîß Configuraci√≥n:")
    print("   config.ini - Ajustes del sistema")
    print("\n" + "="*60)

def main():
    """Funci√≥n principal del setup"""
    print("üß¨ PCR Termophilic Cells Interactive Videomapping")
    print("="*60)
    
    # Verificar Python
    if not check_python_version():
        return False
    
    # Instalar dependencias
    if not install_dependencies():
        print("‚ùå Error instalando dependencias")
        return False
    
    # Crear directorios
    create_directories()
    
    # Crear configuraci√≥n
    create_config_file()
    
    # Verificar componentes
    camera_ok = check_camera()
    opengl_ok = check_opengl()
    
    if not camera_ok:
        print("‚ö†Ô∏è  Advertencia: La c√°mara no est√° disponible")
        print("   El proyecto funcionar√° pero sin interactividad de manos")
    
    if not opengl_ok:
        print("‚ùå Error: OpenGL no est√° disponible")
        print("   El proyecto requiere OpenGL para funcionar")
        return False
    
    # Ejecutar prueba
    if run_test():
        show_usage()
        return True
    else:
        print("‚ùå Error en la prueba del sistema")
        return False

if __name__ == "__main__":
    success = main()
    if not success:
        print("\n‚ùå La instalaci√≥n no se complet√≥ correctamente")
        print("   Revisa los errores anteriores e intenta nuevamente")
        sys.exit(1)
    else:
        print("\n‚úÖ Instalaci√≥n completada exitosamente")
        sys.exit(0) 